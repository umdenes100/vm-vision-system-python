<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vision System</title>

  <link rel="stylesheet" href="/static/bootstrap.css">
  <link rel="stylesheet" href="/static/header.css">
  <link rel="stylesheet" href="/static/index.css">
  <link rel="stylesheet" href="/static/inputs.css">
  <link rel="stylesheet" href="/static/theme.css">

  <style>
    html, body { height: 100%; margin: 0; }

    .vs-header {
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 18px;
      background: #e21833;
      color: #fff;
      box-shadow: 0 2px 0 rgba(0,0,0,0.2);
      gap: 16px;
    }
    .vs-title { font-weight: 700; font-size: 26px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .vs-nav { display: flex; gap: 18px; justify-content: flex-end; white-space: nowrap; }
    .vs-nav a { color: #fff; text-decoration: none; font-weight: 600; font-size: 14px; opacity: 0.95; }
    .vs-nav a:hover { text-decoration: underline; opacity: 1.0; }

    .vs-main { height: calc(100vh - 64px); display: flex; background: #000; }

    .vs-left {
      width: 540px; min-width: 500px; max-width: 640px;
      height: 100%; padding: 12px; box-sizing: border-box;
    }

    .vs-panel {
      background: #1a1a1a;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 8px;
      color: #eaeaea;
      overflow: hidden;
    }

    .vs-panel-header {
      padding: 10px 12px;
      font-weight: 700;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
    }

    .vs-team-select {
      width: 100%;
      margin-bottom: 10px;
      background: #0f0f0f;
      color: #eaeaea;
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 6px;
      padding: 8px 10px;
    }

    .vs-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 10px; }
    .vs-table th, .vs-table td {
      border: 1px solid rgba(255,255,255,0.10);
      padding: 6px;
      white-space: nowrap;
      text-align: left;
    }
    .vs-table th { background: rgba(255,255,255,0.05); }

    .vs-scrollbox {
      width: 100%;
      background: #0d0d0d;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 6px;
      padding: 8px;
      color: #eaeaea;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      line-height: 1.35;
      overflow-y: scroll;
      overflow-x: hidden;
      white-space: pre-wrap;
      box-sizing: border-box;
    }

    .vs-left-stack { height: 100%; display: flex; flex-direction: column; }
    .vs-left-top { padding: 12px 12px 0 12px; }
    .vs-left-bottom {
      flex: 1; min-height: 0;
      padding: 0 12px 12px 12px;
      display: flex; flex-direction: column;
    }
    .vs-left-prints { flex: 1; min-height: 0; margin-bottom: 10px; }

    .vs-switch-row { display: flex; align-items: center; gap: 10px; margin-top: 8px; }
    .vs-switch { position: relative; width: 52px; height: 28px; flex: 0 0 auto; }
    .vs-switch input { opacity: 0; width: 0; height: 0; }
    .vs-slider {
      position: absolute; inset: 0;
      background: #444;
      border-radius: 999px;
      transition: .2s;
      border: 1px solid rgba(255,255,255,0.18);
    }
    .vs-slider:before {
      content: "";
      position: absolute;
      width: 22px; height: 22px;
      left: 3px; top: 2.5px;
      background: #ddd;
      border-radius: 50%;
      transition: .2s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }
    .vs-switch input:checked + .vs-slider { background: #2b7a2b; }
    .vs-switch input:checked + .vs-slider:before { transform: translateX(24px); background: #fff; }

    .vs-right {
      flex: 1;
      height: 100%;
      padding: 12px 12px 12px 0;
      box-sizing: border-box;
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 10px;
      min-width: 0;
      align-content: start;
    }

    .vs-video-region {
      background: #1a1a1a;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 8px;
      overflow: hidden;
      padding: 10px;
      box-sizing: border-box;
    }

    .vs-video-frame {
      width: 100%;
      aspect-ratio: 2 / 1;
      background: #000;
      border-radius: 6px;
      overflow: hidden;
      display: block;
    }

    .vs-video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      background: #000;
    }

    .vs-system-prints {
      background: #1a1a1a;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 8px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 160px;
    }

    .vs-system-prints .vs-panel-body {
      flex: 1;
      min-height: 0;
      padding: 10px;
      box-sizing: border-box;
    }

    .vs-system-prints-box { height: 100%; min-height: 0; }

    .vs-btn {
      width: 100%;
      border-radius: 8px;
      border: none;
      padding: 10px;
      font-weight: 800;
      background: #e21833;
      color: #fff;
      margin-top: 10px;
      cursor: pointer;
    }
  </style>
</head>

<body>

<header class="vs-header">
  <div class="vs-title" id="headerTitle">&lt;Class Name&gt; &lt;Room Placeholder&gt; Vision System</div>
  <nav class="vs-nav" id="headerLinks"></nav>
</header>

<div class="vs-main">

  <aside class="vs-left">
    <div class="vs-panel vs-left-stack">
      <div class="vs-panel-header">Team</div>

      <div class="vs-left-top">
        <select class="vs-team-select" id="teamSelect" disabled>
          <option selected>No Teams Connected</option>
        </select>

        <table class="vs-table">
          <thead>
            <tr>
              <th>Mission Type</th>
              <th>ArUco ID</th>
              <th>ArUco Visible</th>
              <th>X</th>
              <th>Y</th>
              <th>Theta</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td id="cellMissionType">--</td>
              <td id="cellArucoId">--</td>
              <td id="cellVisible">--</td>
              <td id="cellX">--</td>
              <td id="cellY">--</td>
              <td id="cellTheta">--</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="vs-left-bottom">
        <div class="vs-scrollbox vs-left-prints" id="teamPrints"></div>

        <div class="vs-switch-row">
          <label class="vs-switch">
            <input type="checkbox" id="autoscroll" checked>
            <span class="vs-slider"></span>
          </label>
          <span>Autoscroll</span>
        </div>

        <div class="vs-switch-row">
          <label class="vs-switch">
            <input type="checkbox" id="showDisconnected">
            <span class="vs-slider"></span>
          </label>
          <span>Show disconnected teams</span>
        </div>

        <button class="vs-btn" id="clearPrints">CLEAR PRINTS</button>
      </div>
    </div>
  </aside>

  <section class="vs-right">
    <div class="vs-video-region">
      <div class="vs-video-frame">
        <img class="vs-video" id="mainStream" src="/crop" alt="Cropped Stream" />
      </div>
    </div>

    <div class="vs-system-prints">
      <div class="vs-panel-header">System Printouts</div>
      <div class="vs-panel-body">
        <div class="vs-scrollbox vs-system-prints-box" id="systemPrints">[INFO] Waiting for system logs...</div>
      </div>
    </div>
  </section>

</div>

<script src="/static/uiconfig.js"></script>

<script>
  (function () {
    const teamSelect = document.getElementById("teamSelect");
    const teamBox = document.getElementById("teamPrints");
    const systemBox = document.getElementById("systemPrints");
    const autoscroll = document.getElementById("autoscroll");
    const showDisconnected = document.getElementById("showDisconnected");
    const clearBtn = document.getElementById("clearPrints");

    const cellMissionType = document.getElementById("cellMissionType");
    const cellArucoId = document.getElementById("cellArucoId");
    const cellVisible = document.getElementById("cellVisible");
    const cellX = document.getElementById("cellX");
    const cellY = document.getElementById("cellY");
    const cellTheta = document.getElementById("cellTheta");

    // Per-team log buffers (cap at 100)
    const teamLogs = new Map(); // team -> array of lines (<=100)

    // Team roster state from backend:
    // name -> {connected, teamType, aruco, visible, x, y, theta}
    const roster = new Map();

    let selectedTeam = null;

    function maybeScroll(box) {
      if (autoscroll.checked) box.scrollTop = box.scrollHeight;
    }

    function renderSelectedTeamLogs() {
      if (!selectedTeam) {
        teamBox.textContent = "";
        return;
      }
      const lines = teamLogs.get(selectedTeam) || [];
      teamBox.textContent = lines.join("\n");
      maybeScroll(teamBox);
    }

    function renderSelectedTeamRow() {
      if (!selectedTeam || !roster.has(selectedTeam)) {
        cellMissionType.textContent = "--";
        cellArucoId.textContent = "--";
        cellVisible.textContent = "--";
        cellX.textContent = "--";
        cellY.textContent = "--";
        cellTheta.textContent = "--";
        return;
      }

      const st = roster.get(selectedTeam);

      cellMissionType.textContent = st.teamType || "--";
      cellArucoId.textContent = (st.aruco === undefined || st.aruco === null) ? "--" : String(st.aruco);
      cellVisible.textContent = st.visible ? "YES" : "NO";
      cellX.textContent = (typeof st.x === "number") ? st.x.toFixed(3) : "--";
      cellY.textContent = (typeof st.y === "number") ? st.y.toFixed(3) : "--";
      cellTheta.textContent = (typeof st.theta === "number") ? st.theta.toFixed(6) : "--";
    }

    function rebuildDropdown() {
      const allowDisconnected = showDisconnected.checked;

      const names = [...roster.keys()]
        .filter(name => {
          const st = roster.get(name);
          if (!st) return false;
          return st.connected || allowDisconnected;
        })
        .sort((a, b) => a.localeCompare(b));

      teamSelect.innerHTML = "";

      if (names.length === 0) {
        teamSelect.disabled = true;
        const opt = document.createElement("option");
        opt.selected = true;
        opt.textContent = "No Teams Connected";
        teamSelect.appendChild(opt);
        selectedTeam = null;
        renderSelectedTeamLogs();
        renderSelectedTeamRow();
        return;
      }

      teamSelect.disabled = false;
      for (const n of names) {
        const opt = document.createElement("option");
        opt.value = n;
        opt.textContent = n;
        teamSelect.appendChild(opt);
      }

      // keep current selection if possible
      if (selectedTeam && names.includes(selectedTeam)) {
        teamSelect.value = selectedTeam;
      } else {
        selectedTeam = names[0];
        teamSelect.value = selectedTeam;
      }

      renderSelectedTeamLogs();
      renderSelectedTeamRow();
    }

    teamSelect.addEventListener("change", () => {
      selectedTeam = teamSelect.value || null;
      renderSelectedTeamLogs();
      renderSelectedTeamRow();
    });

    showDisconnected.addEventListener("change", () => {
      rebuildDropdown();
    });

    clearBtn.addEventListener("click", () => {
      if (!selectedTeam) return;
      teamLogs.set(selectedTeam, []);
      renderSelectedTeamLogs();
    });

    function appendSystemLine(line) {
      if (systemBox.textContent.startsWith("[INFO] Waiting for system logs...")) {
        systemBox.textContent = "";
      }
      systemBox.textContent += (systemBox.textContent.length ? "\n" : "") + line;
      systemBox.scrollTop = systemBox.scrollHeight; // autoscroll system by default
    }

    function appendTeamLine(team, line) {
      if (!team) return;
      if (!teamLogs.has(team)) teamLogs.set(team, []);
      const buf = teamLogs.get(team);

      buf.push(line);
      while (buf.length > 100) buf.shift();

      if (team === selectedTeam) {
        renderSelectedTeamLogs();
      }
    }

    function updateRoster(list) {
      if (!Array.isArray(list)) return;

      for (const item of list) {
        const name = String(item?.name || "").trim();
        if (!name) continue;
        roster.set(name, {
          connected: !!item.connected,
          teamType: String(item.teamType || ""),
          aruco: (item.aruco === undefined || item.aruco === null) ? -1 : Number(item.aruco),
          visible: !!item.visible,
          x: Number(item.x),
          y: Number(item.y),
          theta: Number(item.theta),
        });

        // Ensure log buffer exists
        if (!teamLogs.has(name)) teamLogs.set(name, []);
      }

      rebuildDropdown();
      renderSelectedTeamRow();
    }

    function connectWs() {
      const proto = (location.protocol === "https:") ? "wss" : "ws";
      const ws = new WebSocket(`${proto}://${location.host}/ws`);

      ws.onmessage = (ev) => {
        const raw = String(ev.data || "");
        if (!raw) return;

        try {
          const msg = JSON.parse(raw);

          if (msg.type === "system_log" && typeof msg.line === "string") {
            appendSystemLine(msg.line);
            return;
          }

          if (msg.type === "team_log" && typeof msg.team === "string" && typeof msg.line === "string") {
            appendTeamLine(msg.team, msg.line);
            return;
          }

          if (msg.type === "team_roster" && Array.isArray(msg.teams)) {
            updateRoster(msg.teams);
            return;
          }

        } catch (_) {
          // ignore non-json
        }
      };

      ws.onclose = () => setTimeout(connectWs, 1000);
      ws.onerror = () => { try { ws.close(); } catch (_) {} };
    }

    connectWs();
    rebuildDropdown();
    renderSelectedTeamRow();
  })();
</script>

</body>
</html>
